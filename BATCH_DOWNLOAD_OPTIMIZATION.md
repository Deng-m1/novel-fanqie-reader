# 批量下载优化说明

## 📊 下载方式说明

### 当前的下载机制

番茄小说下载器使用 **批量请求模式**（Official Batch Mode）：

```
章节列表 → 分批处理 → 批量API请求 → 并发下载
```

### 🔢 批次大小

**修改前：** 每批 **10 章**
**修改后：** 每批 **5 章**

## ❌ 遇到的问题

### 错误日志
```
JSONDecodeError: Expecting value: line 1 column 1 (char 0)
Batch download failed after 26.18s
```

### 问题原因

1. **API 返回空响应**
   - 番茄小说 API 没有返回有效的 JSON 数据
   - 可能返回了 HTML 错误页面或空内容

2. **可能的触发因素**
   - 🚫 请求频率过高（API 限流）
   - 🚫 单次请求章节过多（10章可能超负荷）
   - 🚫 IID 失效或被封（虽然会自动更换）
   - 🚫 服务端反爬虫机制
   - 🚫 网络临时故障

## ✅ 优化方案

### 方案 1：降低批次大小（已实施）

**修改位置：** `backend/novel_downloader/novel_src/network_parser/downloader.py`

**修改内容：**
```python
# 原代码（第 129 行）
groups = [to_download[i : i + 10] for i in range(0, len(to_download), 10)]

# 新代码
batch_size = 5  # 从 10 章改为 5 章
groups = [to_download[i : i + batch_size] for i in range(0, len(to_download), batch_size)]
```

**优点：**
- ✅ 降低单次请求负担
- ✅ 减少被限流的风险
- ✅ 提高下载成功率
- ✅ 即使失败，影响范围更小（只有5章而非10章）

**缺点：**
- ⚠️ 总请求次数增加（但更稳定）
- ⚠️ 总下载时间可能略微增加

### 方案 2：增加等待时间（已实施）

**修改位置：** `.env` 文件

```bash
# 原配置
NOVEL_MIN_WAIT_TIME=2000
NOVEL_MAX_WAIT_TIME=5000

# 新配置
NOVEL_MIN_WAIT_TIME=3000  # 增加 1 秒
NOVEL_MAX_WAIT_TIME=6000  # 增加 1 秒
```

**效果：**
- 每批次请求之间增加 1 秒等待
- 降低请求频率，减少限流风险

### 方案 3：重试机制（已内置）

下载器已有重试机制：
- 最大重试次数：`NOVEL_MAX_RETRIES=3`
- 失败后自动重试
- 重试间隔：指数退避（0.5s, 1s, 2s）

## 📈 性能对比

### 下载 100 章的对比

#### 批次大小 = 10
```
总批次数：10 批
并发数：3（workers）
理论最快：4 轮（10/3向上取整）
单批时间：~3-5秒
估计总时间：12-20秒
失败风险：较高（单批10章）
```

#### 批次大小 = 5（优化后）
```
总批次数：20 批
并发数：3（workers）
理论最快：7 轮（20/3向上取整）
单批时间：~2-3秒（负载更小）
估计总时间：14-21秒
失败风险：较低（单批5章）
成功率：更高
```

**结论：** 时间略微增加，但成功率大幅提升

## 🔄 下载流程详解

### 预览模式（10 章）

```
1. 获取章节列表：1845 章
   ↓
2. 限制为前 10 章（max_chapters=10）
   ↓
3. 分批：[第1-5章], [第6-10章]
   ↓
4. 并发下载（最多3个worker）
   批次1: 第1-5章（5章ID用逗号拼接）→ API请求
   批次2: 第6-10章（5章ID用逗号拼接）→ API请求
   ↓
5. 解析响应，保存到数据库
```

### API 请求示例

**批次 1 请求：**
```
GET /reading/reader/batch_full/v?item_ids=7208456691589841412,7208480498526454272,7208581376894435898,7208584415205655078,7208832484782375435
```

**批次 2 请求：**
```
GET /reading/reader/batch_full/v?item_ids=7208832945748967992,7209170768813523496,7209173072451109414,7209543139680485928,7209627020777488936
```

## 🛠️ 故障排查

### 如果仍然失败

1. **检查 IID 是否有效**
   ```bash
   # 查看 .env 文件
   NOVEL_IID=1303336016968585
   NOVEL_IID_SPAWN_TIME=1745421697340
   ```
   - IID 会自动更换（12小时一次）
   - 如果频繁失败，可能需要手动获取新的 IID

2. **进一步降低批次大小**
   ```python
   batch_size = 3  # 改为每批 3 章
   ```
   或
   ```python
   batch_size = 1  # 改为单章下载（最稳定但最慢）
   ```

3. **增加更多等待时间**
   ```bash
   NOVEL_MIN_WAIT_TIME=5000  # 5秒
   NOVEL_MAX_WAIT_TIME=8000  # 8秒
   ```

4. **减少并发数**
   ```bash
   NOVEL_MAX_WORKERS=1  # 从3改为1，完全串行
   ```

5. **使用重新下载功能**
   - 在任务列表中找到失败的任务
   - 点击"重新下载"按钮
   - 系统会自动重试

## 📊 监控和日志

### 成功的日志
```
[2025-10-03 16:32:04] INFO: Limited to 10 chapters (from 1845) for preview mode.
[2025-10-03 16:32:04] INFO: Starting chapter download...
Downloading '开局神豪系统，不好意思我无敌了' (Official Batch): 100%|██████████| 10/10
[2025-10-03 16:32:34] INFO: Saved/Merged 10 chapters. 0 errors/missing.
```

### 失败的日志
```
[2025-10-03 16:32:34] ERROR: Batch download failed after 26.18s: JSONDecodeError
[2025-10-03 16:32:34] WARNING: Skipping chapter ... due to error marker
[2025-10-03 16:32:34] INFO: Saved/Merged 0 chapters. 10 errors/missing.
```

## 🎯 最佳实践建议

1. **首次下载**
   - 使用"前十章预览"测试稳定性
   - 如果成功，再下载全本

2. **大量下载**
   - 避免短时间内下载多本小说
   - 给每本小说之间留出 1-2 分钟间隔

3. **失败重试**
   - 第一次失败后等待 5-10 分钟
   - 使用"重新下载"功能重试
   - 多次失败可能需要更换 IID

4. **网络环境**
   - 确保网络稳定
   - 避免使用VPN或代理（可能被识别）
   - 高峰时段可能成功率较低

## 🔮 未来优化方向

1. **自适应批次大小**
   - 根据成功率动态调整
   - 失败多时自动降低批次

2. **智能重试**
   - 失败后自动降级批次大小
   - 指数退避重试策略

3. **IID 池管理**
   - 维护多个有效 IID
   - 失败时自动切换

4. **请求限流器**
   - 全局请求频率限制
   - 防止触发反爬虫

## ✅ 总结

本次优化将批次大小从 **10 章降至 5 章**，同时增加了请求等待时间，预期可以：

- ✅ 提高下载成功率
- ✅ 降低 API 限流风险
- ✅ 提升系统稳定性
- ⚠️ 略微增加总下载时间（可接受）

**建议：** 重启服务后重新尝试下载，应该能看到明显改善！
